name: Build Box

on:
  workflow_dispatch:
    inputs:
      rebuild:
        description: '强制重新构建（忽略缓存）'
        type: boolean
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set Up Python 3.8
        uses: actions/setup-python@v5
        with:
          python-version: '3.8'

      - name: Install Python Dependencies (Bypass Chaquopy pip)
        run: |
          python -m pip install --upgrade pip
          pip install lxml ujson pyquery requests jsonpath cachetools pycryptodome beautifulsoup4

      - name: Create local.properties
        run: echo "sdk.dir=/usr/local/lib/android/sdk" > local.properties

      - name: Fix pyramid/build.gradle (Remove Windows Python Path)
        if: ${{ hashFiles('pyramid/build.gradle') != '' }}
        run: |
          sed -i '/buildPython.*python\.exe/d' pyramid/build.gradle
          grep -n "buildPython" pyramid/build.gradle || true

      - name: Set Version Tag
        run: |
          TAG=$(date -u +"%Y%m%d-%H%M")
          echo "BUILD_TAG=$TAG" >> $GITHUB_ENV
          echo "Using version tag: $TAG"

      - name: Update Version in build.gradle and About Dialog
        run: |
          sed -i "/versionName/s#[0-9a-zA-Z_\.\'\"-]\+\$#\'${{ env.BUILD_TAG }}\'#" app/build.gradle
          if [ -f "app/src/main/res/layout/dialog_about.xml" ]; then
            sed -i "/android:text=/s#=\"#=\"${{ env.BUILD_TAG }}\\\\n\\\\n#" app/src/main/res/layout/dialog_about.xml
          fi

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build Release APK
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease --build-cache --parallel

      - name: Find and Verify APK
        id: find_apk
        run: |
          APK_PATH=$(find . -path "*/build/outputs/apk/release/*.apk" | head -n1)
          if [ -z "$APK_PATH" ]; then
            echo "❌ No APK found! Build may have failed."
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "✅ Found APK: $APK_PATH"

      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: TVBox-${{ env.BUILD_TAG }}
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 7
